---
title: "Elk Sightability Basic Report"
subtitle: "An initial summary of camera trap data from June to September 2021 in the Sechelt Peninsula"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  word_document:
always_allow_html: TRUE
 
---

```{r setup and tests, include=FALSE, warnings=F, message=F}

## README FIRST ##
#Read and run this chunk of code line by line in the R Console (do not press knit) - there are some questions below which you will have to answer and some logic tests to complete. Once you are happy that the conditions have been satisfied, hit 'knit' above. 

# Load packages
list.of.packages <- c("leaflet", "dplyr", "colortools", "kriging", "corrplot", "lubridate", "kableExtra", "tidyr", "ggplot2", "gridExtra", "activity", "overlap", "webshot", "flextable",
                      "PNWColors")

# Check you have them and load them
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
lapply(list.of.packages, require, character.only = TRUE)

# Load your data [change the files paths to your data locations]
load("C:/Users/TBRUSH/R/SPCS_R/input/processed_data/SPCS_standard_input.RData")

# Timezone [Use UTC if your cameras do not correct for daylight saving time, if they do use the timezone where the data was collected]
tz <- "UTC"

# Set the "independence" interval in minutes
independent <- 30

# Set a single categorical variable of interest from station covariates for summary graphs. If you do not have an appropriate category, use "project_id".
category <- "project_id"

# Define a colour palette from the package PNWColors
# Can be viewed at https://github.com/jakelawlor/PNWColors#install-package
pal <- "Bay"

# Set focal species (those you want to include in in-depth analysis) and irrelevant species(those you want to exclude from basic results like sex, age, behaviour)
irr_spe <- c("Humans","Dogs","Cats","Unknown species", "Mice", "Birds")
foc_spe <- c("Elk", "Deer", "Bears", "Bobcats", "Coyotes", "Wolves")

# Set species which you want collar/tag data for
mrk_spe <- "Elk"

# Set your season dates if you don't have them already or want to change them for this report

ind.dat <- ind.dat %>%
  mutate(month = month(date_time)) %>%
  mutate(season = if_else(month >= 5 & month <= 10, "Summer", "Winter")) %>%
  select(-month)

seas.eff <- row.lookup %>%
  mutate(month = month(date)) %>%
  mutate(season = if_else(month >= 5 & month <= 10, "Summer", "Winter")) %>%
  group_by(station_id, season) %>%
  summarize(days = n())

```


```{r non-adjustable options, echo=F, include=F}

# Count the number of camera stations
n_sta <- length(unique(eff$station_id))

# Generate colours to display the category levels - R needs them as a factor
sta[,category] <- factor(sta[,category])
col.cat <- pnw_palette(pal, (length(levels(sta[,category])) ))
col.cat <- rev(col.cat)
sta$cols <- col.cat[sta[,category]]

# order eff by station_id
eff <- arrange(eff, by="station_id")

# How big should the figures be
eff.height <- 8
if(length(unique(eff$station_id))>80)
   {
     eff.height <- length(unique(eff$station_id))/10
   }

sp.height <- 5
if(length(unique(dat$species))>20)
   {
     sp.height <- 5+(length(unique(dat$species))/8)
   }

# Create a mode function
getmode <- function(v) {
   uniqv <- unique(v)
   uniqv[which.max(tabulate(match(v, uniqv)))]
}

```

# Acknowledgements


# Table of Contents


# Executive Summary


# Introduction
## Project Scope


## Background


## Objectives


# Methods
## Study Area


## Camera Field Study

Cameras were deployed in June 2021 at `r n_sta` unique locations.

```{r map, fig.height=8, fig.width=6, echo=F, fig.cap= "Camera deployment sites."}

m <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="satellite") %>%  # Add satellite data
  
  addCircles(lng = sta$longitude, 
                   lat = sta$latitude,
                   color = "white", radius = 250, 
                   opacity = 1,
                   weight=0.5, fillColor = col.cat[1], 
                   fillOpacity = 1,
                   label = paste(sta$station_id))
 # addLegend("bottomleft", colors = col.cat,  
 #           labels = str_to_sentence(levels(sta[,category]), 
 #                                    locale = "en"),
 #           title = str_to_sentence(category),
 #           labFormat = labelFormat(prefix = "$"), 
 #           opacity = 1)

m

```

# Results

## Raw Camera Detections

To date, `r nrow(dat)` images have undergone classification by species, sex, age, behaviour, and groups size. In total, `r length(levels(factor(dat$species)))-1` species were detected (excluding unknown species). The following figure summarizes detections by species.

```{r detections, echo=F, fig.height=sp.height, fig.width=6}
layout(matrix(c(1,1,2), 1, 3, byrow = TRUE))
det.sum.total <- as.data.frame(count(dat[is.na(dat$species)==FALSE,], report_names))
det.sum.total <- det.sum.total[order(det.sum.total$n),]

i <-1
for(i in 1:nrow(det.sum.total))
{
  tmp <- subset(dat, report_names==det.sum.total$report_names[i])
  det.sum.total$locations[i] <- length(unique(tmp$station_id))
}

par(mar=c(5,16,1,1))
barplot(det.sum.total$n, names.arg = paste0(det.sum.total$report_names, 
                                           " (n = ", det.sum.total$n, ", ",
                                           round((det.sum.total$locations/n_sta)*100),
                                           "%)"), 
        las=1, cex.names=1, xlab="Total detections", horiz=T)

par(mar=c(5,1,1,1))

barplot(det.sum.total$locations/n_sta, las=1, cex.names=1, xlab="Proportion of sites detected", horiz=T, xlim=c(0,1))
abline(v=1, lty=2)


```


**Detection Map**

```{r detection map, fig.width=6, fig.height=8, echo=F, fig.cap="A map of stations from which images were recovered. Circle size corresponds to the number of images recovered from the site."}

sta.det <- dat %>%
  filter(!(report_names %in% c(irr_spe))) %>%
  group_by(station_id) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-latitude, -longitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det <- full_join(sta, sta.det, by = "station_id")

scale <- 2

m_det <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
  addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=as.numeric(sta.det$cr)*scale,
             weight=1, fillOpacity = 0.6,
             color=col.cat[1],
              label=paste(sta.det$station_id, 
                         sta.det$det, sep=", ")) %>%
  addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
  
m_det

```

## Independent camera detections

Using an independence threshold of `r independent` minutes, the number of independent capture events is `r nrow(ind.dat)`. The rest of the analyses are conducted with this data. A summary of image events is as follows:

```{r ind detections figure, echo=F, eval=T, fig.width=6, fig.height=sp.height}

layout(matrix(c(1,1,2), 1, 3, byrow = TRUE))
ind.det.sum.total <- as.data.frame(count(ind.dat, report_names))
ind.det.sum.total <- ind.det.sum.total[order(ind.det.sum.total$n),]
ind.det.sum.total <- left_join(ind.det.sum.total, det.sum.total[,c(1,3)], by="report_names")

i <-1
for(i in 1:nrow(ind.det.sum.total))
{
  tmp <- subset(ind.dat, report_names==ind.det.sum.total$report_names[i])
  ind.det.sum.total$animal_count[i] <- sum(tmp$event_groupsize)
}

par(mar=c(5,16,1,1))
barplot(ind.det.sum.total$n, names.arg = paste0(ind.det.sum.total$report_names,
                                           " (n = ", ind.det.sum.total$n, ", ",
                                           # ind.det.sum.total$animal_count, ",", 
                                           round(ind.det.sum.total$locations/n_sta*100), "%)"),
        las=1, cex.names=1, xlab="Total independent detections", horiz=T,
        xlim=c(0,2500))

par(mar=c(5,1,1,1))


barplot(ind.det.sum.total$animal_count, las=1, cex.names=1, xlab="Total animals counted", horiz=T, xlim = c(0,3000))


```

```{r sex ind, echo=F, include=F}
col.name <- "sex"

plot<-FALSE
if(length(colnames(ind.dat)[colnames(ind.dat)==col.name]>0))
   {
      tmp <- table(ind.dat[,col.name], as.character(ind.dat$report_names))
      tmp <- as.data.frame.matrix(tmp)
      tmp <- tmp[ , !(names(tmp) %in% irr_spe)]
      
      ind.dat[,col.name]<- factor(ind.dat[,col.name]) %>%
        droplevels()
      cols <- pnw_palette(pal, length(levels(ind.dat[,col.name])))
      # Name categories with no data N\A for NOT ASSESSED
row.names(tmp)[row.names(tmp)==""] <- "N/A"
      # make it the last level
tmp <- tmp[c(2:nrow(tmp),1),]
      
      data_percentage <- apply(tmp, 2, function(x){x*100/sum(x,na.rm=T)})
      plot<-TRUE
  }

```


```{r sex ind plot, echo=F, fig.width=6, fig.height=sp.height}
if(plot==TRUE)
{
layout(matrix(c(1,1,1,2), 1, 4, byrow = TRUE))
par(mar=c(5,10,1,1))
barplot(data_percentage , border="white",col= cols, ylab="", las=1, xlab="% of events", cex.names=0.9, horiz=2)
par(mar=c(0,0,4,0))
plot.new()
legend("topleft", legend=row.names(tmp), fill=cols, xpd=TRUE, cex=1.1 )
} else { print('Not included') }
```

```{r age ind, echo=F, include=F}
col.name <- "age"

plot<-FALSE
if(length(colnames(ind.dat)[colnames(ind.dat)==col.name]>0))
   {
      tmp <- table(ind.dat[,col.name], as.character(ind.dat$report_names))
      tmp <- as.data.frame.matrix(tmp)
      tmp <- tmp[ , !(names(tmp) %in% irr_spe)]
      
      ind.dat[,col.name]<- factor(ind.dat[,col.name])
      cols <- pnw_palette(pal, length(levels(ind.dat[,col.name])))
      # Name catagories with no data N\A for NOT ASSESSED
      row.names(tmp)[row.names(tmp)==""] <- "N/A"
      # make it the last level
      tmp <- tmp[c(2:nrow(tmp),1),]
      
      data_percentage <- apply(tmp, 2, function(x){x*100/sum(x,na.rm=T)})
      plot<-TRUE
  }

```

```{r age ind plot, echo=F, fig.width=6, fig.height=sp.height}
if(plot==TRUE)
{
layout(matrix(c(1,1,1,2), 1, 4, byrow = TRUE))
par(mar=c(5,10,1,1))
barplot(data_percentage , border="white",col= cols, ylab="", las=1, xlab="% of events", cex.names=0.9, horiz=2)
par(mar=c(0,0,4,0))
plot.new()
legend("topleft", legend=row.names(tmp), fill=cols, xpd=TRUE, cex=1.1 )
} else { print('Not included') }

```

```{r Behaviour ind, echo=F, include=F}
col.name <- "behaviour"
plot<-FALSE
if(length(colnames(ind.dat)[colnames(ind.dat)==col.name]>0))
   {
      tmp <- table(ind.dat[,col.name][!(ind.dat$report_names %in% irr_spe)], as.character(ind.dat$report_names[!(ind.dat$report_names %in% irr_spe)]))
      tmp <- as.data.frame.matrix(tmp)
      tmp$total <- rowSums(tmp)
      tmp <- tmp[tmp$total != 0 , 1:10]

      
      ind.dat[,col.name]<- factor(ind.dat[,col.name])
      cols <- pnw_palette(pal, nrow(tmp))
      # Name catagories with no data N\A for NOT ASSESSED
      # row.names(tmp)[row.names(tmp)==""] <- "N/A"
      # make it the last level
      # tmp <- tmp[c(2:nrow(tmp),1),]
      
      data_percentage <- apply(tmp, 2, function(x){x*100/sum(x,na.rm=T)})
      plot<-TRUE
  }
```

```{r behaviour ind plot, echo=F, fig.width=6, fig.height=sp.height}
if(plot==TRUE)
{
layout(matrix(c(1,1,1,2), 1, 4, byrow = TRUE))
par(mar=c(5,10,1,1))
barplot(data_percentage , border="white",col= cols, ylab="", las=1, xlab="% of events", cex.names=0.9, horiz=2)
par(mar=c(0,0,4,0))
plot.new()
legend("topleft", legend=row.names(tmp), fill=cols, xpd=TRUE, cex=1.1 )
} else { print('Not included') }
```
**Independent detection map**

```{r independent map, fig.width=6, fig.height=8, echo=F}

sta.deti <- ind.dat %>%
  filter(!(report_names %in% c(irr_spe))) %>%
  group_by(station_id) %>%
  summarize(det = n(),
            animals = sum(event_groupsize)) %>%
  distinct() %>%
  left_join(eff %>% select(-latitude, -longitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.deti <- full_join(sta, sta.deti, by = "station_id")

scale <- 15

m_deti <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
   
  addCircles(lng=sta.deti$longitude, lat=sta.deti$latitude,
             radius=as.numeric(sta.deti$cr)*scale,
             weight=1, fillOpacity = 0.6,
             color=col.cat[1],
             label=paste(sta.deti$station_id, 
                         sta.deti$det, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_deti

```


**Site-level species covariance**

This plot shows the co variance between different species at the site level for species with >5 unique detections. A positive value indicates that the two species commonly occur at the same sites, while a negative value indicates that the two species are rarely present at the same site.

```{r covariance, echo=F, fig.width=6, fig.height=sp.height, eval=T}
par(mfrow=c(1,1))
tmp <- as.data.frame.matrix(table(ind.dat$station_id, ind.dat$report_names))
tmp <- tmp[colSums(tmp)>5]
M <- cor(tmp)

corrplot(M, method="color", col=rev(pnw_palette(pal, 100, type="continuous")),
         type="upper", order="hclust",
         #addCoef.col = "black", # Add coefficient of correlation
         tl.col="black", tl.srt=45, #Text label color and rotation
         # Combine with significance
         #p.mat = p.mat, sig.level = 0.01, insig = "blank",
         # hide correlation coefficient on the principal diagonal
         diag=FALSE
         )

```

### Focal species data

**Distance sampling**

```{r distance hist, fig.width=6, fig.height=3.5}
# Filter to focal species
dist <- dat %>%
  filter(!is.na(distance),
         report_names %in% c(foc_spe))
dist %>%
  ggplot(aes(distance)) +
  geom_histogram(color="white", binwidth = 1) +
  facet_wrap(~report_names, scales = "free") +
  labs(x = "Distance to camera (m)", y = "Frequency")
```

#### Elk

**Group size distribution**

```{r group size, echo=F, eval=T, fig.width=6, fig.height=4}
ind.dat %>%
  filter(report_names == "Elk") %>%
  group_by(sex) %>%
  summarize(mean_group = mean(group_count),
            sd = sd(group_count),
            n = n(),
            st_err = sd/sqrt(n)) %>%
  ggplot(aes(sex, mean_group)) +
  geom_col() +
  scale_x_discrete(name="") +
  scale_y_continuous(name="Average group size") +
  coord_flip() +
  geom_errorbar(aes(x = sex, 
                    ymin = mean_group - st_err, 
                    ymax = mean_group + st_err))

```

**Detection maps**

```{r elk detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

sta.det.elk <- ind.dat %>%
  filter(report_names=="Elk") %>%
  group_by(station_id) %>%
  summarize(det = n(),
            animals = sum(event_groupsize)) %>%
  distinct() %>%
  left_join(eff %>% select(-latitude, -longitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det.elk <- inner_join(sta, sta.det.elk, by = "station_id")

scale <- 100

m_det.elk <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
   
  addCircles(lng=sta.det.elk$longitude,
             lat=sta.det.elk$latitude,
             color=pnw_palette(pal, 1),
             radius=as.numeric(sta.det.elk$cr)*scale,
             weight=1, fillOpacity = 0.7,
             label=paste(sta.det.elk$station_id, 
                         sta.det.elk$det, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_det.elk

```

```{r elk age detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

age.det.elk <- ind.dat %>%
  filter(report_names=="Elk") %>%
  group_by(station_id, age) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

age.det.elk <- inner_join(sta,age.det.elk, by = "station_id")
cols <- pnw_palette(pal, 2)

scale <- 100

m_age.elk <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
   
  addCircles(lng=age.det.elk$longitude[age.det.elk$age=="Adult"],
             lat=age.det.elk$latitude[age.det.elk$age=="Adult"],
             radius=as.numeric(age.det.elk$cr[age.det.elk$age=="Adult"])*scale,
             color=cols[1],
             weight=1, fillOpacity = 0.5,
             label=paste(age.det.elk$station_id, 
                         age.det.elk$det, sep=", ")) %>%

  addCircles(lng=age.det.elk$longitude[age.det.elk$age=="Adult + Juvenile"],
             lat=age.det.elk$latitude[age.det.elk$age=="Adult + Juvenile"],
             radius=as.numeric(age.det.elk$cr
                               [age.det.elk$age=="Adult + Juvenile"])*scale,
             weight=1, fillOpacity = 0.5,
             color=cols[2],
             label=paste(age.det.elk$station_id, 
                         age.det.elk$det, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white") %>%
  addLegend("bottomleft", colors = c(cols),  
           labels = c("Adults", "Adults + Juveniles"),
           title = "Age category",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 1)

m_age.elk

```

```{r elk seasonal detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}
seas.elk <- ind.dat %>%
  filter(report_names=="Elk") %>%
  group_by(station_id, season) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(seas.eff, by=c("station_id", "season")) %>%
  mutate(cr = det/days*100)

seas.elk <- inner_join(sta,seas.elk, by = "station_id")

scale <- 80

m_summer.elk <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>% 
   
  addCircles(lng=seas.elk$longitude[seas.elk$season=="Summer"],
             lat=seas.elk$latitude[seas.elk$season=="Summer"],
             radius=as.numeric(seas.elk$cr[seas.elk$season=="Summer"])*scale,
             weight=0.5, fillOpacity = 0.5, fillColor=cols[2], color=cols[2],
             label=paste(seas.elk$station_id, 
                         seas.elk$cr, sep=", ")) %>%

      addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white") %>%
  addLegend("bottomleft", colors = cols[c(1,2)],  
           labels = c("Winter", "Summer"),
           title = "Season",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 0.7)

m_summer.elk

m_winter.elk <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>% 

  addCircles(lng=seas.elk$longitude[seas.elk$season=="Winter"],
             lat=seas.elk$latitude[seas.elk$season=="Winter"],
             radius=as.numeric(seas.elk$cr[seas.elk$season=="Winter"])*scale,
             weight=0.5, fillOpacity = 0.5,
             fillColor=cols[1], color=cols[1],
             label=paste(seas.elk$station_id, 
                         seas.elk$cr, sep=", ")) %>%
  
      addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
  
  m_winter.elk

```

*Marked animals*

The cameras detected collared individuals in `r length(ind.dat$collar[ind.dat$collar==T])` events across `r length(unique(ind.dat$station_id[ind.dat$collar==T]))` stations, comprising `r length(unique(mrk_spe))` species.

```{r collars, fig.width=6, fig.height=3, include=FALSE}
collars <- ind.dat %>%
  filter(collar==T) %>%
  group_by(collar_tags, station_id) %>%
  summarize(event_count = n()) 

collars <- left_join(collars, sta[,c(1,3,4)], by = "station_id") %>%
  mutate(collar_tags = factor(collar_tags),
         # jitter lat & long so that points aren't on top of each other
         latitude = jitter(latitude, factor = 0.005),
         longitude = jitter(longitude, factor = 0.005))



col.cat <- pnw_palette(pal, (length(levels(collars$collar_tags))))
col.cat <- rev(col.cat)
collars$color <- col.cat[collars$collar_tags]

m_collars <- leaflet(options = leafletOptions(attributionControl=FALSE,
                                              zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>% 
  #  
  # addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
  #            radius=800,
  #            weight=0, fillOpacity = 0.2,
  #            color="white") %>%
  addCircles(lng=collars$longitude,
             lat=collars$latitude,
             radius=300,
             weight=0.5, fillOpacity = 0.9, fillColor=collars$color,
             label = collars$collar_tags) %>%

  addLegend("bottomleft", colors = unique(collars$color),  
           labels = unique(collars$collar_tags),
           title = "Collar ID",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 0.7)

m_collars

```


#### Deer

**Detection maps**

```{r deer detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

sta.det.deer <- ind.dat %>%
  filter(report_names=="Deer") %>%
  group_by(station_id) %>%
  summarize(det = n(),
            animals = sum(event_groupsize)) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det.deer <- inner_join(sta, sta.det.deer, by = "station_id")

scale <- 40

m_det.deer <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
   
  addCircles(lng=sta.det.deer$longitude, lat=sta.det.deer$latitude,
             radius=as.numeric(sta.det.deer$cr)*scale,
             weight=1, fillOpacity = 0.7,
             color=cols[1],
             label=paste(sta.det.deer$station_id, 
                         sta.det.deer$det, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_det.deer

```

```{r deer age detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

age.det.deer <- ind.dat %>%
  filter(report_names=="Deer") %>%
  group_by(station_id, age) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

age.det.deer <- inner_join(sta,age.det.deer, by = "station_id")

scale <- 45

m_age.deer <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
   
  addCircles(lng=age.det.deer$longitude[age.det.deer$age=="Adult"],
             lat=age.det.deer$latitude[age.det.deer$age=="Adult"],
             radius=as.numeric(age.det.deer$cr[age.det.deer$age=="Adult"])*scale,
             weight=1, fillOpacity = 0.5, color=cols[1],
             label=paste(age.det.deer$station_id, 
                         age.det.deer$det, sep=", ")) %>%

  addCircles(lng=age.det.deer$longitude[age.det.deer$age=="Adult + Juvenile"],
             lat=age.det.deer$latitude[age.det.deer$age=="Adult + Juvenile"],
             radius=as.numeric(age.det.deer$cr[age.det.deer$age=="Adult + Juvenile"])*scale,
             weight=1, fillOpacity = 0.5,
             color=cols[2],
             label=paste(age.det.deer$station_id, 
                         age.det.deer$det, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white") %>%
  addLegend("bottomleft", colors = c(cols),  
           labels = c("Adults", "Adults + Juveniles"),
           title = "Age category",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 1)

m_age.deer

```

```{r deer seasonal detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

seas.deer <- ind.dat %>%
  filter(report_names=="Deer") %>%
  group_by(station_id, season) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(seas.eff, by=c("station_id", "season")) %>%
  mutate(cr = det/days*100)

seas.deer <- inner_join(sta,seas.deer, by = "station_id")

scale <- 35

m_summer.deer <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>% 
   
  addCircles(lng=seas.deer$longitude[seas.deer$season=="Summer"],
             lat=seas.deer$latitude[seas.deer$season=="Summer"],
             radius=as.numeric(seas.deer$cr[seas.deer$season=="Summer"])*scale,
             weight=0.5, fillOpacity = 0.5, fillColor=cols[2], color=cols[2],
             label=paste(seas.deer$station_id[seas.deer$season=="Summer"], 
                         seas.deer$cr[seas.deer$season=="Summer"], sep=", ")) %>%

      addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white") %>%
  addLegend("bottomleft", colors = cols,  
           labels = c("Winter", "Summer"),
           title = "Season",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 0.7)

m_summer.deer

m_winter.deer <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>% 

  addCircles(lng=seas.deer$longitude[seas.deer$season=="Winter"],
             lat=seas.deer$latitude[seas.deer$season=="Winter"],
             radius=as.numeric(seas.deer$cr[seas.deer$season=="Winter"])*scale,
             weight=0.5, fillOpacity = 0.5,
             fillColor=cols[1], color=cols[1],
             label=paste(seas.deer$station_id[seas.deer$season=="Winter"], 
                         seas.deer$cr[seas.deer$season=="Winter"], sep=", ")) %>%
      addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
  
  m_winter.deer

```

#### Bears

```{r bear detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

sta.det.bear <- ind.dat %>%
  filter(report_names=="Bears") %>%
  group_by(station_id) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det.bear <- inner_join(sta, sta.det.bear, by = "station_id")

scale <- 200

m_det.bear <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
    addCircles(lng=sta.det.bear$longitude, lat=sta.det.bear$latitude,
             radius=as.numeric(sta.det.bear$cr)*scale,
             weight=1, fillOpacity = 0.7,
             color=cols[1],
             label=paste(sta.det.bear$station_id, 
                         sta.det.bear$cr, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_det.bear

```


```{r bear age detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

age.det.bear <- ind.dat %>%
  filter(report_names=="Bears") %>%
  group_by(station_id, age) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

age.det.bear <- inner_join(sta,age.det.bear, by = "station_id")

scale <- 200

m_age.bear <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
   
  addCircles(lng=age.det.bear$longitude[age.det.bear$age=="Adult"],
             lat=age.det.bear$latitude[age.det.bear$age=="Adult"],
             radius=as.numeric(age.det.bear$cr[age.det.bear$age=="Adult"])*scale,
             weight=0.5, fillOpacity = 0.4, 
             fillColor=cols[1],
             label=paste(age.det.bear$station_id, 
                         age.det.bear$det, sep=", ")) %>%

  addCircles(lng=age.det.bear$longitude[age.det.bear$age=="Adult + Juvenile"],
             lat=age.det.bear$latitude[age.det.bear$age=="Adult + Juvenile"],
             radius=as.numeric(age.det.bear$cr[age.det.bear$age=="Adult + Juvenile"])*scale,
             weight=0.5, fillOpacity = 0.4,
             fillColor=cols[2],
             label=paste(age.det.bear$station_id, 
                         age.det.bear$cr, sep=", ")) %>%
      addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white") %>%
  addLegend("bottomleft", colors = col.cat[c(1, 9)],  
           labels = c("Adults", "Adults + Juveniles"),
           title = "Age category",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 1)

m_age.bear

```


#### Capture rates

```{r relative abundance calc, echo=F, warning=F, message=F, eval=T}

det.sum.site <- as.data.frame(table(ind.dat$station_id[ind.dat$report_names %in% foc_spe], ind.dat$report_names[ind.dat$report_names %in% foc_spe]))
colnames(det.sum.site) <- c("station_id","species", "detections")
det.sum.site$individuals <- NA

i <- 1
for(i in 1:nrow(det.sum.site))
{
   tmp <- subset(ind.dat, station_id==as.character(det.sum.site$station_id)[i] &
              species==as.character(det.sum.site$species)[i])
   det.sum.site$individuals[i] <- sum(tmp$group_count, na.rm=T)
}

# Join with the station effort
CR.site <- left_join(det.sum.site,aggregate(days~station_id, data=eff,  FUN=sum, na.rm=T) )
CR.site$CR.100 <- round((CR.site$individuals/CR.site$days)*100,3)
# Add station locations
CR.site <- left_join(CR.site, sta[, c("station_id", "latitude", "longitude")])

```


**Monthly Capture Rates**

Across all focal species, variation in monthly capture rates are as follows:

```{r monthly CR, echo=F, eval=T}
# Capture rates through time
foc_spe <- foc_spe[order(foc_spe)]
# Remove any blanks
foc_spe <- foc_spe[foc_spe!=""]

# Now determine capture rates using the row.lookup
# Make a data frame by month and year
mon.dat <- unique(substr(ind.dat$date_time, 1,7))
mon.dat <- data.frame("month"=mon.dat[order(mon.dat)], "effort"= NA)
mon.dat[as.character(foc_spe)] <- NA
i<-1
for(i in 1:nrow(mon.dat))
{
  mon.dat$effort[i] <- nrow(subset(row.lookup, substr(row.lookup$date,1,7)==mon.dat$month[i]))
  mon.dat$total.CR[i] <- (nrow(subset(ind.dat, substr(ind.dat$date_time,1,7)==mon.dat$month[i]))/mon.dat$effort[i])*100
}

#exclude months with all cameras active for <5 days
mon.dat <- mon.dat %>%
  filter(effort >= 280)

for(i in 1:length(foc_spe))
{
  for(j in 1:nrow(mon.dat))
  {
    tmp <- subset(ind.dat, report_names==as.character(foc_spe)[i] & substr(ind.dat$date_time,1,7)==mon.dat$month[j])
    mon.dat[j, as.character(foc_spe[i])] <- (nrow(tmp)/mon.dat$effort[j])*100
  }
}

mon.dat$timestamp <- strptime(paste0(as.character(mon.dat$month),"-15"), "%Y-%m-%d")

# Remove any silly values 
mon.dat <- mon.dat[is.infinite(mon.dat$total.CR)==F,]

```

```{r monthly CR plot, echo=F, eval=T, fig.width=8, fig.height=4}

par(mfrow=c(1,2))

plot(mon.dat$timestamp, mon.dat$effort, ylab="Monthly effort (days)", xlab="Date", type="l", las=1, xaxt="n")
points(mon.dat$timestamp, mon.dat$effort, pch=19, col=rgb(0,0,0,0.4))
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)

# Overall capture rate
plot(mon.dat$timestamp, mon.dat$total.CR, ylab="Monthly total CR per 100 days", xlab="Date", type="l", las=1, ylim=c(0, max(mon.dat$total.CR)), xaxt = "n")
points(mon.dat$timestamp, mon.dat$total.CR, pch=19, col=rgb(0,0,0,0.4))
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)

```

*Species-specific temporal trends*

Species level variation in monthly capture rates are as follows:

```{r species CR, eval=FALSE, fig.height=sp.height, fig.width=6, include=FALSE}

col.cat <- pnw_palette(pal, length(foc_spe))

plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, max(mon.dat[,3:(2+length(foc_spe))])+5), las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)

legend("topright", as.character(foc_spe), col=col.cat, lwd = 1)

for(i in 1:length(foc_spe))
{
  lines(mon.dat$timestamp, mon.dat[,as.character(foc_spe)[i]],  type="l", lwd=1.5,
        col=col.cat[i])
  points(mon.dat$timestamp, mon.dat[,as.character(foc_spe)[i]], pch=19, cex=0.8,
         col="black")
}


```

```{r elk CR}
plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, ceiling(max(mon.dat$Elk)+1)), main="Elk", las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)
axis(2, at = seq(0, ceiling(max(mon.dat$Elk)), 1))
  lines(mon.dat$timestamp, mon.dat$Elk,  type="l", lwd=1.5)
  points(mon.dat$timestamp, mon.dat$Elk, pch=19, cex=0.8)
```
```{r bears CR}
plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, ceiling(max(mon.dat$Bears)+1)), main="Bears", las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)
axis(2, at = seq(0, ceiling(max(mon.dat$Bears)), 1))
  lines(mon.dat$timestamp, mon.dat$Bears,  type="l", lwd=1.5)
  points(mon.dat$timestamp, mon.dat$Bears, pch=19, cex=0.8)
```

```{r Deer CR}
plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, ceiling(max(mon.dat$Deer)+1)), main="Deer", las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)
axis(2, at = seq(0, ceiling(max(mon.dat$Deer)), 2))
  lines(mon.dat$timestamp, mon.dat$Deer,  type="l", lwd=1.5)
  points(mon.dat$timestamp, mon.dat$Deer, pch=19, cex=0.8)
```

### Other Species
#### Bobcat

```{r bobcat detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

sta.det.bobcat <- ind.dat %>%
  filter(report_names=="Bobcats") %>%
  group_by(station_id) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det.bobcat <- inner_join(sta, sta.det.bobcat, by = "station_id")

scale <- 350

m_det.bobcat <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
    addCircles(lng=sta.det.bobcat$longitude, lat=sta.det.bobcat$latitude,
             radius=as.numeric(sta.det.bobcat$cr)*scale,
             weight=1, fillOpacity = 0.7,
             color=cols[1],
             label=paste(sta.det.bobcat$station_id, 
                         sta.det.bobcat$cr, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_det.bobcat

```

```{r Bobcats CR}
plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, ceiling(max(mon.dat$Bobcats))), main="Bobcats", las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)
axis(2, at = seq(0, ceiling(max(mon.dat$Bobcats)), 0.1))
  lines(mon.dat$timestamp, mon.dat$Bobcats,  type="l", lwd=1.5)
  points(mon.dat$timestamp, mon.dat$Bobcats, pch=19, cex=0.8)
```

#### Coyote

```{r coyote detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

sta.det.coyote <- ind.dat %>%
  filter(report_names=="Coyotes") %>%
  group_by(station_id) %>%
  summarize(det = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det.coyote <- inner_join(sta, sta.det.coyote, by = "station_id")

scale <- 250

m_det.coyote <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
    addCircles(lng=sta.det.coyote$longitude, lat=sta.det.coyote$latitude,
             radius=as.numeric(sta.det.coyote$cr)*scale,
             weight=1, fillOpacity = 0.7,
             color=cols[1],
             label=paste(sta.det.coyote$station_id, 
                         sta.det.coyote$cr, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_det.coyote

```


```{r Coyotes CR}
plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, ceiling(max(mon.dat$Coyotes))), main="Coyotes", las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)
axis(2, at = seq(0, ceiling(max(mon.dat$Coyotes)), 0.5))
  lines(mon.dat$timestamp, mon.dat$Coyotes,  type="l", lwd=1.5)
  points(mon.dat$timestamp, mon.dat$Coyotes, pch=19, cex=0.8)
```

#### Wolf

```{r wolf detection map, fig.width=6, fig.height=8, echo=F, message=FALSE, warning=FALSE}

sta.det.wolf <- ind.dat %>%
  filter(report_names=="Wolves") %>%
  group_by(station_id) %>%
  summarize(det  = n()) %>%
  distinct() %>%
  left_join(eff %>% select(-longitude, -latitude), by="station_id") %>%
  mutate(cr = det/days*100)

sta.det.wolf <- inner_join(sta, sta.det.wolf, by = "station_id")

scale <- 1000

m_det.wolf <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="Satellite") %>%  # Add satellite data
    addCircles(lng=sta.det.wolf$longitude, lat=sta.det.wolf$latitude,
             radius=as.numeric(sta.det.wolf$cr)*scale,
             weight=1, fillOpacity = 0.7,
             color=cols[1],
             label=paste(sta.det.wolf$station_id, 
                         sta.det.wolf$cr, sep=", ")) %>%
    addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=1,
             weight=1, fillOpacity = 1,
             color="white")
m_det.wolf

```



```{r Wolves CR}
plot(c(min(mon.dat$timestamp, na.rm=T), max(mon.dat$timestamp, na.rm=T)),
     c(0, max(mon.dat$Wolves)), main="Wolves", las=1, ylab="Capture Rate per 100 days",  
     xlab="", type="n", yaxt="n", xaxt="n")
axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)
axis(2, at = seq(0, max(mon.dat$Wolves), 0.05))
  lines(mon.dat$timestamp, mon.dat$Wolves,  type="l", lwd=1.5)
  points(mon.dat$timestamp, mon.dat$Wolves, pch=19, cex=0.8)
```

### Human data

```{r human data, echo=F, message=FALSE, warning=FALSE, include=F}
human.dat <- ind.dat %>%
  filter(species=="Homo sapiens") %>%
  group_by(station_id) %>%
  summarize(events = n(),
            most_popular=as.character(getmode(behaviour)))
human.sta <- human.dat %>%
  full_join(sta, by="station_id") %>%
  mutate(most_popular = if_else(is.na(most_popular), "NA", most_popular))

human.sta$most_popular <- factor(human.sta$most_popular)

col.cat <- pnw_palette(pal, length(levels(human.sta$most_popular)))
human.sta$cols <- col.cat[human.sta$most_popular]

```

```{r human map, fig.width=6, fig.height=8, echo=F}

m_hum <- leaflet(options = leafletOptions(attributionControl=FALSE, zoomControl=F)) %>%
  addProviderTiles(providers$Esri.WorldImagery, group="satellite") %>%  # Add satellite data
  
  addCircles(lng = human.sta$longitude, 
                   lat = human.sta$latitude,
                   fillColor = human.sta$cols, 
                   color=human.sta$cols,
                   radius = (if_else(is.na(human.sta$events), 200,
                                     200+human.sta$events*50)),
                   weight=0.5,
                   fillOpacity = 0.5,
                   label = c(human.sta$station_id, human.sta$events)) %>%
  
      addCircles(lng=sta.det$longitude, lat=sta.det$latitude,
             radius=50,
             weight=1, fillOpacity = 1,
             color="white") %>%
  
 addLegend("bottomleft", colors = c(col.cat[c(1,2,4)], col.cat[3]),  
           labels = c(levels(human.sta$most_popular)[c(1,2,4)], "NA"),
           title = "Most popular activity",
           labFormat = labelFormat(prefix = "$"), 
           opacity = 1)
m_hum

```

# Appendix A
## Species names

```{r species names, echo=F, include=T}
species.names <- dat %>%
  ungroup() %>%
  select(species, common_names, report_names) %>%
  unique() %>%
  filter(common_names != "") %>%
  arrange(species) %>%
  transmute("Latin name" = species, "Common names" = common_names, "Used in report" = report_names)

flextable(species.names, cwidth = c(1.5, 3, 1.5))

```

# Appendix B
## Classification definitions

# Appendix C
## Camera activity

```{r cam activity, echo=F, fig.height=9, fig.width=6}
n_sta <- 56

eff <- left_join(eff, snow_eff %>% select(-end_date, -snow_days), by="station_id")

# Adjust layout
par(mar=c(2,6,1,1))
plot(c(min(eff$start_date, na.rm=T), 
       max(eff$end_date, na.rm=T)), 
       c(1,n_sta+5), las=1, ylab="", xlab="", type="n", yaxt="n", xaxt="n")

# Have the first station plot at the top 
plot.order <- rev(unique(eff$station_id))

axis(2, at= 1:n_sta, labels= plot.order, las=1, cex.axis=0.6)
col.cat <- pnw_palette("Bay", 4)
legend("topright", c("Active", "Active, covered in snow"), lwd = c(2, 3), col = c("black", col.cat[2]))

# Vertical lines for months
abline(v=as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), col=rgb(0,0,0,0.1))

axis(1, at = as.numeric(strptime(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),"months"),
                             "%Y-%m-%d")), 
     labels = format.Date(seq(as.Date(paste0(substr(min(eff$start_date,
                                                           na.rm=T),
                                                       1,7),"-01")),
                                 as.Date(max(eff$end_date, na.rm=T)),
                              "months"),"%b"),
     cex.axis = 0.8)


mtext("Station ID", 2, 4, cex = 1)
# Make lines for each of the cameras
for(i in 1:length(plot.order))
{
  abline(h=i, col=rgb(0,0,0,0.1))
  tmp <- eff[eff$station_id==plot.order[i],]
  for(j in 1:nrow(tmp))
    {
      lines(c(tmp$start_date[j],
                       tmp$end_date[j]),
            c(i,i), lwd=2)
  }
}

for(i in 1:length(plot.order))
{
  tmp <- eff[eff$station_id==plot.order[i],]
  for(j in 1:nrow(tmp))
    {
     if(tmp$covered_period[j] == 1)
    {
      lines(c(tmp$pause1[j],
              tmp$resume1[j]),
            c(i,i), lwd=3, col=col.cat[2])
    }
  if(tmp$covered_period[j] == 2)
    {
      lines(c(tmp$pause1[j],
              tmp$resume1[j]),
            c(i,i), lwd=3, col=col.cat[2])
      lines(c(tmp$pause2[j],
              tmp$resume2[j]),
            c(i,i), lwd=3, col=col.cat[2])
    }
  if(tmp$covered_period[j] == 3)
    {
      lines(c(tmp$pause1[j],
              tmp$resume1[j]),
            c(i,i), lwd=3, col=col.cat[2])
      lines(c(tmp$pause2[j],
              tmp$resume2[j]),
            c(i,i), lwd=3, col=col.cat[2])
      lines(c(tmp$pause3[j],
              tmp$resume3[j]),
            c(i,i), lwd=3, col=col.cat[2])
    }  
  if(tmp$covered_period[j] == 4)
    {
      lines(c(tmp$pause1[j],
              tmp$resume1[j]),
            c(i,i), lwd=3, col=col.cat[2])
      lines(c(tmp$pause2[j],
              tmp$resume2[j]),
            c(i,i), lwd=3, col=col.cat[2])
      lines(c(tmp$pause3[j],
              tmp$resume3[j]),
            c(i,i), lwd=3, col=col.cat[2])
      lines(c(tmp$pause4[j],
              tmp$resume4[j]),
            c(i,i), lwd=3, col=col.cat[2])
    }
  }
}



```

# Appendix D
## Detection check

```{r det species colors, include=F}
library(stringr)
# Make species colour codes
tmp3 <- data.frame("species"=str_sort(unique(dat$report_names)),"Colour"= as.character(pnw_palette(pal, length(unique(dat$report_names)))))

```

```{r detecion summary, echo=F, message=F, warning=F, fig.width=6, fig.height=8}

# Make a separate plot for each station
# To do this make a plot dataframe
tmp4 <- data.frame("station_id"=rev(plot.order), "Plot.grp"=ceiling(1:length(unique(eff$station_id))/20))


eff <- left_join(eff,tmp4, by="station_id")
i <- 1
j <- 1
for(j in 1:length(unique(eff$Plot.grp)))
{
    layout(matrix(c(1,1,1,2), 1, 4, byrow = TRUE))
    par(mar=c(2,6,1,1))
    
    plot(c(min(eff$start_date, na.rm=T), max(eff$end_date, na.rm=T)),      c(1,length(unique(eff$station_id[eff$Plot.grp==j]))), las=1, ylab="", xlab="", type="n", yaxt="n")
    
    axis(2, at= 1:length(unique(eff$station_id[eff$Plot.grp==j])), labels= unique(eff$station_id[eff$Plot.grp==j]), las=1, cex.axis=1)
    #mtext("Camera Deployment ID", 2, 4)
    # Make lines for each of the cameras
    for(i in 1:length(unique(eff$station_id[eff$Plot.grp==j])))
    {
      abline(h=i, col=rgb(0,0,0,0.1))
      tmp <- eff[eff$station_id==unique(eff$station_id[eff$Plot.grp==j])[i],]
      
      tmp2 <- dat[dat$station_id==tmp$station_id[1],]
      tmp2 <- left_join(tmp2, tmp3, by = c("report_names"= "species"))
      points(tmp2$date_time, rep(i,nrow(tmp2)), pch="|", col= tmp2$Colour)
    
      for(k in 1:nrow(tmp))
        {
          lines(c(tmp$start_date[k],
                           tmp$end_date[k]),
                c(i,i), lwd=2)
        }
      }
    par(mar=c(0,0,1,0))
    plot.new()
    legend("topleft", legend=tmp3$species, fill=tmp3$Colour, xpd=TRUE, cex=1.1 )

}

```

```{r echo=F, eval=F}
### Data exporting for analysis
Finally, this script outputs 10 useful data frames for future data analysis:

1. A data frame of "independent detections" at the `r independent` minute threshold you specified at the start: 

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent.csv")`"
  
2. The "effort lookup" which is a dataframe of all days a given camera station was active. Some people use an effort matrix for this step, but we find the long format is much easier to use in downstream analysis. 
  - "`r paste0("processed_data/",dat$project_id[1], "_daily_effort_lookup.csv")`"  

3 & 4: A 'site x species' matrix of the number of independent detections and species counts across the full study period:

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_total_observations.csv")`"

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_total_counts.csv")`"


5 & 6: A 'site_month x species' matrix of the number of independent detections and species counts across for each month in the study period:

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Monthly_total_observations.csv")`"

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Monthly_total_counts.csv")`"


7 & 8: A 'site_week x species' matrix of the number of independent detections and species counts across for each week in the study period:

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Weekly_total_observations.csv")`"

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Weekly_total_counts.csv")`"
  
9 & 10: A 'site_day x species' matrix of the number of independent detections and species counts across for each day a station was active in the study period:

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Daily_total_observations.csv")`"

  - "`r  paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Daily_total_counts.csv")`"
  
```


```{r, echo=F, eval=FALSE}
# Only do this for species you are interested in
ind.dat <- ind.dat[ind.dat$species %in% foc_spe,]
ind.dat$species <- factor(ind.dat$species)
#levels(ind.dat$species)
```

```{r, echo=F, message=F, warning=F, eval=F}
# Total counts
  # Station / Month / Effort / Species      
  tmp <- row.lookup
  
  # Calculate the number of days at each site  
  total.obs <- tmp %>% 
      group_by(station_id) %>%
      summarise(effort = n())
  # Convert to a data frame
  total.obs <- as.data.frame(total.obs)
  
  # Add columns for each species  
  total.obs[, levels(ind.dat$species)] <- NA
  # Duplicate for counts
  total.count <- total.obs
  # Test counter
  i <-1
  # For each station, count the number of individuals/observations
  for(i in 1:nrow(total.obs))
    {
      tmp <- ind.dat[ind.dat$station_id==total.obs$station_id[i],]
      
      for(j in 1:length(levels(ind.dat$species)))
      {
        total.obs[i,levels(ind.dat$species)[j]] <- length(tmp$species[tmp$species==levels(ind.dat$species)[j]])
        total.count[i,levels(ind.dat$species)[j]] <- sum(tmp$event_groupsize[tmp$species==levels(ind.dat$species)[j]])
      }
    }

#write.csv(total.obs, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_total_observations.csv"), row.names = F) 

#write.csv(total.count, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_total_counts.csv"), row.names = F) 

```

```{r, echo=F, message=F, warning=F, eval=F}

# Monthly counts
  # Station / Month / Effort / Covariates / Species      
  tmp <- row.lookup
  # Simplify the date to monthly
  tmp$date <- substr(tmp$date,1,7)
  
  # Calculate the number of days in each month  
  mon.obs <- tmp %>% 
      group_by(station_id,date ) %>%
      summarise(effort = n())
  # Convert to a data frame
  mon.obs <- as.data.frame(mon.obs)
    
  mon.obs[, levels(ind.dat$species)] <- NA
  mon.count <- mon.obs
  # For each month, count the number of individuals/observations
  for(i in 1:nrow(mon.obs))
    {
      tmp <- ind.dat[ind.dat$station_id==mon.obs$station_id[i] & substr(ind.dat$date_time,1,7)== mon.obs$date[i],]
      for(j in 1:length(levels(ind.dat$species)))
      {
        mon.obs[i,levels(ind.dat$species)[j]] <- length(tmp$species[tmp$species==levels(ind.dat$species)[j]])
        mon.count[i,levels(ind.dat$species)[j]] <- sum(tmp$event_groupsize[tmp$species==levels(ind.dat$species)[j]])
      }
    }

  
#write.csv(mon.obs, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_Monthly_observations.csv"), row.names = F) 

#write.csv(mon.count, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_Monthly_counts.csv"), row.names = F) 

```


```{r, echo=F, message=F, warning=F, eval=F}
# Weekly format
  # Station / Month / Effort / Covariates / Species      
  tmp <- row.lookup
  # Simplify the date to year-week
  tmp$date <- strftime(tmp$date, format = "%Y-W%U")
  # The way this is coded is the counter W01 starts at the first sunday of the year, everything before that is W00. Weeks do not roll accross years.
  
  # Calculate the number of days in each week  
  week.obs <- tmp %>% 
      group_by(station_id,date ) %>%
      summarise(effort = n())
  
  # Convert to a data frame
  week.obs <- as.data.frame(week.obs)
  # Add species columns  
  week.obs[, levels(ind.dat$species)] <- NA
  week.count <- week.obs
  # For each week, count the number of individuals/observations
  for(i in 1:nrow(week.obs))
    {
      tmp <- ind.dat[ind.dat$station_id==week.obs$station_id[i] & strftime(ind.dat$date_time, format = "%Y-W%U")== week.obs$date[i],]
      
      
      
      for(j in 1:length(levels(ind.dat$species)))
      {
        week.obs[i,levels(ind.dat$species)[j]] <- length(tmp$species[tmp$species==levels(ind.dat$species)[j]])
        week.count[i,levels(ind.dat$species)[j]] <- sum(tmp$event_groupsize[tmp$species==levels(ind.dat$species)[j]])
      }
    }
#write.csv(week.obs, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_weekly_observations.csv"), row.names = F) 

#write.csv(week.count, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_weekly_counts.csv"), row.names = F) 

```


```{r, echo=F, message=F, warning=F, eval=F}
# Daily format
  # Station / Month / Effort / Covariates / Species      
  tmp <- row.lookup
  tmp$effort <- 1
  # Add species columns  
  tmp[, levels(ind.dat$species)] <- NA
  
  day.obs <- tmp
  day.count <- tmp
# For each week, count the number of individuals/observations
  for(i in 1:nrow(day.obs))
    {
      tmp <- ind.dat[ind.dat$station_id==day.obs$station_id[i] & strftime(ind.dat$date_time, format = "%Y-%m-%d")== day.obs$date[i],]
      
      
      
      for(j in 1:length(levels(ind.dat$species)))
      {
        day.obs[i,levels(ind.dat$species)[j]] <- length(tmp$species[tmp$species==levels(ind.dat$species)[j]])
        day.count[i,levels(ind.dat$species)[j]] <- sum(tmp$event_groupsize[tmp$species==levels(ind.dat$species)[j]])
      }
    }
#write.csv(day.obs, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_daily_observations.csv"), row.names = F) 

#write.csv(day.count, paste0("processed_data/",dat$project_id[1], "_",independent ,"min_Independent_daily_counts.csv"), row.names = F) 

```

